## Sink Azure Event Hub topic into ADLSgen2 using Azure HDInsight Flink on AKS

This sample uses Datastream API on Azure HDInsight Flink on AKS to consumer streaming data from Azure Eventub Kafka and then store JSON data into ADLS gen2.
Json data in Azure Eventhub is generated by the feature of Generate data (preview) on Azure Eventhub portal.

## Prerequisites
•	HDInsight Flink 1.16.0 on AKS<br>
•	Azure Eventhub(Note:Make sure connectivity between Azure Eventhub and HDInsight Flink cluster)<br>
•	For this demonstration, we are using a Window VM as maven project develop env in the same VNET as HDInsight on AKS<br>

## HDInsight Flink 1.16.0 on AKS

![image](https://github.com/Baiys1234/eventhubskafka-flink-adlsgen2/assets/35547706/617cc34c-0aad-4bc7-ba4e-7ce9fe62cb92)

## Generate data Azure Eventhub click_events:

Eventhub Instance:
click_events (contseventhub/click_events) | Generate data (preview)

Select Dataset: Clickstream data
Repeat Send: 100
``` json
[
    {
        "timeStamp": "2020-12-29 9:30:20",
        "ipAddress": "123.45.60.45",
        "userId": "469b775c-6ab0-48ce-b321-08dc26c3b6cf",
        "sessionId": "a7f4b4bb-1107-4a35-b1dd-fb666de8edc7",
        "path": "/.netlify/functions/registration",
        "queryParameters": "?token=12345-ABCD",
        "referrerUrl": "http://example.com/about.html",
        "os": "Windows",
        "browser": "Chrome",
        "timeToCompletePage": 2100,
        "eventFirstTimestamp": 365476,
        "eventDuration": 1000,
        "eventScore": 95,
        "deviceType": "phone",
        "isLead": true,
        "diagnostics": ""
    },
……………
    {
        "timeStamp": "2020-07-25 9:15:25",
        "ipAddress": "90.12.45.67",
        "userId": "31ceebd2-0273-4841-9bf9-316e7bed8845",
        "sessionId": "531d32f2-502e-41f9-9451-3fcdac6ac1ba",
        "path": "/.netlify/functions/contact",
        "queryParameters": "?from=socialMedia",
        "referrerUrl": "http://example.com/contact.html",
        "os": "Windows",
        "browser": "Chrome",
        "timeToCompletePage": 3700,
        "eventFirstTimestamp": 426368,
        "eventDuration": 1900,
        "eventScore": 50,
        "deviceType": "phone",
        "isLead": false,
        "diagnostics": null
    }
]
```

![image](https://github.com/Baiys1234/eventhubskafka-flink-adlsgen2/assets/35547706/f5954a96-c5e1-4320-b06e-a0c8d4c246b6)

![image](https://github.com/Baiys1234/eventhubskafka-flink-adlsgen2/assets/35547706/1da780ce-9803-4b58-af5b-c81407ddf37d)

## source code on Maven project
maven pom.xml:<br>
https://github.com/Baiys1234/eventhubskafka-flink-adlsgen2/blob/main/pom.xml <br>

eventhub connect string configuration file: <br>
https://github.com/Baiys1234/eventhubskafka-flink-adlsgen2/blob/main/resources/consumer.config  <br>

main source code: <br>
https://github.com/Baiys1234/eventhubskafka-flink-adlsgen2/blob/main/contoso.example/EventhubSinkToGen2.java <br>

Note: <br>
How to get an Eventhub connection string

https://learn.microsoft.com/en-us/azure/event-hubs/event-hubs-get-connection-string

## Package the jar and upload it into Flink webssh pod, and put consumer.config into the machine where flink cli runs

```
xxxx@pod-0 [ ~/jar ]$ pwd
/opt/flink-webssh/jar
xxxx@pod-0 [ ~/jar ]$ ls FlinkEventhubDemo-1.0-SNAPSHOT.jar consumer.config
FlinkEventhubDemo-1.0-SNAPSHOT.jar  consumer.config

xxxx@pod-0 [ ~/jar ]$ bin/flink run -c contoso.example.EventhubSinkToGen2 -jar jar/FlinkEventhubDemo-1.0-SNAPSHOT.jar --input jar/consumer.config 
Job has been submitted with JobID 4678dbf011f5a54e565aeb2e3b532ad2
```
### check steaming job on Flink UI
![image](https://github.com/Baiys1234/eventhubskafka-flink-adlsgen2/assets/35547706/31917331-cb45-49e7-b125-bb778483cefc)

## Check output in ADLS gen2

![image](https://github.com/Baiys1234/eventhubskafka-flink-adlsgen2/assets/35547706/917fa201-e4ac-484c-998b-af77f920299f)







